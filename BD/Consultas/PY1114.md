## Definición de 2 eventos que automaticen tareas con diferente periodicidad
### 1.
```sql

```

### 2. Limpiar los productos que no se han vendido en los últimos 30 días (Jessica)
```sql

DELIMITER //
CREATE EVENT limpiarProdictosNoVendidos
ON SCHEDULE EVERY 1 MONTH
DO
BEGIN
    DELETE FROM PRODUCTO
    WHERE codigo_producto NOT IN 
    (SELECT DISTINCT codProducto FROM LINEA_DE_TICKET WHERE fecha_venta >= CURDATE() - INTERVAL 30 DAY);
END
//
DELIMITER ;

-- mysql> SHOW EVENTS;
-- +------------+----------------------------+---------+-----------+-----------+------------+----------------+----------------+---------------------+------+---------+------------+----------------------+----------------------+-----------------------+
-- | Db         | Name                       | Definer | Time zone | Type      | Execute at | Interval value | Interval field | Starts              | Ends | Status  | Originator | character_set_client | collation_connection | Database Collation    |
-- +------------+----------------------------+---------+-----------+-----------+------------+----------------+----------------+---------------------+------+---------+------------+----------------------+----------------------+-----------------------+
-- | panaderia2 | limpiarProdictosNoVendidos | s8a@%   | SYSTEM    | RECURRING | NULL       | 1              | MONTH          | 2025-03-28 09:19:25 | NULL | ENABLED |          1 | utf8mb4              | utf8mb4_unicode_ci   | utf8mb4_uca1400_ai_ci |
-- +------------+----------------------------+---------+-----------+-----------+------------+----------------+----------------+---------------------+------+---------+------------+----------------------+----------------------+-----------------------+
-- 1 row in set (0.00 sec)
```

## Definición de 2 disparadores sobre operaciones asociadas al modelo de datos.
### 1. Trigger que, al actualizar la dirección de un cliente, se quede registrado en la tabla logCambiosDirección para llevar un seguimiento. (Jessica)
```sql
CREATE OR REPLACE TABLE logCambiosDireccion (
    id INT AUTO_INCREMENT,
    idCliente INT ,
    oldDireccion VARCHAR(256),
    newDireccion VARCHAR(256),
    CONSTRAINT pk_logCambiosDireccion PRIMARY KEY (id));


DELIMITER //
CREATE OR REPLACE TRIGGER ac1103triggerGuardarDireccionAfterUpdate
AFTER UPDATE ON CLIENTE FOR EACH ROW
BEGIN
    IF OLD.direccion != NEW.direccion THEN
        INSERT INTO `logCambiosDireccion` (idCliente, oldDireccion, newDireccion)
        VALUES (OLD.idCliente, OLD.direccion, NEW.direccion);
    END IF;
END
//
DELIMITER ;

-- mysql> UPDATE CLIENTE SET direccion = "Calle Miau, 50" WHERE idCliente = 1;
-- Query OK, 1 row affected (0.04 sec)
-- Rows matched: 1  Changed: 1  Warnings: 0

-- mysql> select * from logCambiosDireccion;
-- +----+-----------+-----------------+----------------+
-- | id | idCliente | oldDireccion    | newDireccion   |
-- +----+-----------+-----------------+----------------+
-- |  1 |         1 | Calle Falsa 123 | Calle Miau, 50 |
-- +----+-----------+-----------------+----------------+
-- 1 row in set (0.00 sec)
```

### 2.
```sql

```

## Definición de 2 procedimientos almacenados que realicen más de una operación dentro de una transacción, haciendo una gestión adecuada de los errores, ya sea mediante señales o excepciones, y sus consiguientes manejadores.
### 1.
```sql

```

### 2.
```sql

```

## Definición de 2 procedimientos almacenados que utilicen cursores que recorran cierta cantidad de datos, realizando operaciones sobre una o más tablas, haciendo una gestión adecuada de los errores, ya sea mediante señales o excepciones, y sus consiguientes manejadores.
### 1. Calcular el total gastado por cliente, basándose en el número de compra en la linea_De_ticket, la cantidad de productos comprados y su precio. Si ese cliente no ha realizado ninguna compra o no existe, se imprimirá un mensaje de error. (Jessica)
```sql
DELIMITER //
CREATE OR REPLACE PROCEDURE calcularTotalVentasPorCliente(IN _idCliente INT, OUT totalVentas DECIMAL(10,2))
BEGIN
    DECLARE fin INT DEFAULT 0;
    DECLARE precioProducto DECIMAL(10,2);
    DECLARE numCompra INT;
    DECLARE mensajeError VARCHAR(255);

    DECLARE curVentas CURSOR FOR
        SELECT c.numCompra, l.cantidad * p.precio
        FROM COMPRA c
        JOIN LINEA_DE_TICKET l ON c.numCompra = l.numCompra
        JOIN PRODUCTO p ON l.codProducto = p.codigo
        WHERE c.idCliente = _idCliente;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET fin = 1;

    OPEN curVentas;

    SET totalVentas = 0;

    WHILE FIN = FALSE DO
        FETCH curVentas INTO numCompra, precioProducto;

        IF fin = FALSE THEN
            SET totalVentas = totalVentas + precioProducto;
        END IF;
    END WHILE;

    CLOSE curVentas;

    IF totalVentas = 0 THEN
        SET mensajeError = 'No se encontraron compras para este cliente.';
        SIGNAL SQLSTATE '45000'
            SET MESSAGE_TEXT = mensajeError;
    END IF;

    SELECT totalVentas;

END //
DELIMITER ;

mysql> call calcularTotalVentasPorCliente(2, @totalVentas); 
ERROR 1644 (45000): No se encontraron compras para este cliente.

mysql> call calcularTotalVentasPorCliente(1, @totalVentas);
+-------------+
| totalVentas |
+-------------+
|       17.40 |
+-------------+
1 row in set (0.00 sec)
```

### 2.
```sql

```


